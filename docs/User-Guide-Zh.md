# MySQL 备份工具 - 用户指南

## 概述

MySQL 备份工具是为企业 MySQL 环境设计的综合备份解决方案。它通过客户端-服务器架构提供自动备份调度、加密、压缩和分布式存储功能。

## 目录

1. [入门](#入门)
2. [配置](#配置)
3. [基本操作](#基本操作)
4. [高级功能](#高级功能)
5. [监控和故障排除](#监控和故障排除)
6. [最佳实践](#最佳实践)

---

## 入门

### 系统要求

**客户端要求：**
- Windows 10 或更高版本
- .NET 8.0 运行时
- MySQL 服务器（任何支持的版本）
- 最少 4GB RAM
- 足够的磁盘空间用于临时备份文件

**服务器要求：**
- Windows Server 2019 或更高版本 / Linux（Ubuntu 20.04+）
- .NET 8.0 运行时
- 与客户端机器的网络连接
- 足够的存储空间用于备份文件

### 安装

#### 客户端安装

1. 从发布页面下载最新版本
2. 将文件解压到您所需的安装目录
3. 以管理员身份运行 `MySqlBackupTool.Client.exe`（MySQL 服务管理需要）

#### 服务器安装

1. 下载服务器包
2. 解压到您的服务器目录
3. 在 `appsettings.json` 中配置服务器设置
4. 运行 `MySqlBackupTool.Server.exe` 或安装为 Windows 服务

### 初始设置

1. **启动服务器**：在您的备份存储机器上启动服务器应用程序
2. **配置客户端**：打开客户端应用程序并配置您的第一个备份作业
3. **测试连接**：验证客户端和服务器之间的连接
4. **运行测试备份**：执行测试备份以确保一切正常工作

---

## 配置

### 备份配置

#### 创建新的备份配置

1. 打开 MySQL 备份工具客户端
2. 点击"新建配置"
3. 填写必填字段：

**基本设置：**
- **配置名称**：此备份作业的唯一标识符
- **MySQL 服务名称**：Windows 服务名称（例如，"MySQL80"）
- **数据目录**：MySQL 数据目录路径（例如，`C:\ProgramData\MySQL\MySQL Server 8.0\Data`）

**MySQL 连接：**
- **服务器**：MySQL 服务器主机名或 IP
- **端口**：MySQL 端口（默认：3306）
- **用户名**：具有备份权限的 MySQL 用户名
- **密码**：MySQL 密码（加密存储）
- **数据库**：目标数据库名称（可选，留空表示所有数据库）

**目标服务器：**
- **IP 地址**：备份服务器 IP 地址
- **端口**：备份服务器端口（默认：8080）
- **目标目录**：服务器上存储备份的目录

**文件命名：**
- **命名策略**：从预定义模式中选择或创建自定义模式
- **包含时间戳**：是否在文件名中包含时间戳
- **日期格式**：时间戳格式（例如，`yyyy-MM-dd_HH-mm-ss`）

#### 配置验证

系统自动验证：
- MySQL 连接参数
- 目录可访问性
- 服务器连接
- 命名策略有效性

### 邮件通知

#### SMTP 配置

配置备份状态警报的邮件通知：

```json
{
  "SmtpConfig": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "EnableSsl": true,
    "Username": "your-email@gmail.com",
    "Password": "your-app-password",
    "FromAddress": "backup-system@yourcompany.com",
    "FromName": "MySQL 备份系统"
  }
}
```

#### 邮件模板

系统包含预定义模板：
- **备份成功**：备份成功完成时发送
- **备份失败**：备份失败时发送
- **调度提醒**：计划备份前发送
- **存储警告**：存储空间不足时发送

### 加密设置

#### 基于密码的加密

为备份文件配置 AES-256 加密：

1. 在备份配置中启用加密
2. 设置强加密密码（最少 12 个字符）
3. 配置密钥派生设置：
   - **迭代次数**：PBKDF2 迭代次数（默认：100,000）
   - **密钥大小**：加密密钥大小（默认：256 位）

#### 安全建议

- 为每个备份配置使用唯一的强密码
- 将加密密码存储在安全的密码管理器中
- 定期轮换加密密码
- 定期测试解密过程

---

## 基本操作

### 手动备份

#### 运行一次性备份

1. 选择您的备份配置
2. 点击"立即运行备份"
3. 在状态窗口中监控进度
4. 查看完成状态和日志

#### 备份过程步骤

系统为每个备份遵循以下过程：

1. **备份前验证**
   - 验证 MySQL 服务状态
   - 检查磁盘空间可用性
   - 验证服务器连接

2. **MySQL 服务管理**
   - 安全停止 MySQL 服务
   - 等待完全关闭
   - 验证服务已停止

3. **数据压缩**
   - 将数据目录压缩为 ZIP 文件
   - 报告压缩进度
   - 验证压缩文件完整性

4. **加密（如果启用）**
   - 使用 AES-256 加密压缩文件
   - 生成加密元数据
   - 验证加密文件

5. **文件传输**
   - 将文件传输到备份服务器
   - 支持中断传输的恢复
   - 验证传输完成

6. **备份后任务**
   - 重启 MySQL 服务
   - 验证 MySQL 可用性
   - 清理临时文件
   - 发送通知邮件
   - 更新备份日志

### 备份调度

#### 创建调度

1. 转到"调度"选项卡
2. 点击"新建调度"
3. 配置调度设置：

**调度信息：**
- **名称**：调度的描述性名称
- **备份配置**：选择要运行的备份
- **描述**：可选描述

**时间配置：**
- **调度类型**：从预设或自定义 cron 中选择
- **Cron 表达式**：用于高级调度
- **时区**：调度时区
- **启用**：调度是否活动

#### 常见调度示例

**每日备份：**
- 表达式：`0 0 2 * * *`
- 描述：每天凌晨 2:00

**每周备份：**
- 表达式：`0 0 2 * * 0`
- 描述：每周日凌晨 2:00

**每月备份：**
- 表达式：`0 0 2 1 * *`
- 描述：每月第一天凌晨 2:00

**每小时备份：**
- 表达式：`0 0 * * * *`
- 描述：每小时整点

### 保留管理

#### 设置保留策略

1. 导航到"保留策略"
2. 点击"新建策略"
3. 配置保留规则：

**策略设置：**
- **策略名称**：唯一标识符
- **备份目录**：要管理的目录
- **启用**：策略是否活动

**保留规则：**
- **最大年龄**：备份文件的最大年龄（例如，30 天）
- **最大数量**：要保留的备份文件最大数量
- **最小可用空间**：要维护的最小可用空间

**高级选项：**
- **试运行**：测试策略而不删除文件
- **排除模式**：要从清理中排除的文件
- **优先级**：策略执行优先级

#### 保留策略示例

**30 天保留：**
```
最大年龄：30 天
最大数量：30 个文件
描述：保留每日备份 30 天
```

**每周长期：**
```
最大年龄：365 天
最大数量：52 个文件
文件模式：*weekly*
描述：保留每周备份 1 年
```

**基于存储：**
```
最小可用空间：100 GB
最大数量：100 个文件
描述：维护 100GB 可用空间
```

---

## 高级功能

### 恢复功能

#### 恢复工作原理

系统支持恢复中断的传输：

1. **分块传输**：大文件被分割成块
2. **进度跟踪**：跟踪每个块的传输
3. **恢复令牌**：为中断的传输生成
4. **自动恢复**：系统尝试自动恢复
5. **手动恢复**：用户可以手动恢复传输

#### 配置恢复设置

```json
{
  "TransferConfig": {
    "ChunkSize": 10485760,  // 10MB 块
    "EnableResume": true,
    "ResumeTimeout": "01:00:00",  // 1 小时
    "MaxResumeAttempts": 3
  }
}
```

### 大文件处理

#### 大型数据库优化

对于大于 10GB 的数据库：

1. **分块处理**：文件分割成可管理的块
2. **内存管理**：操作期间优化内存使用
3. **进度报告**：长操作的详细进度
4. **流式操作**：避免将整个文件加载到内存

#### 性能调优

**压缩设置：**
- 使用 `CompressionLevel.Optimal` 获得最佳压缩
- 使用 `CompressionLevel.Fastest` 优先考虑速度
- 根据可用内存调整缓冲区大小

**传输设置：**
- 为更快的网络增加块大小
- 为不可靠的连接减少块大小
- 为多个文件启用并行传输

### 多线程

#### 后台操作

所有长时间运行的操作都在后台线程中运行：

- **备份操作**：运行时不阻塞 UI
- **文件传输**：并行块传输
- **压缩**：多线程压缩
- **加密**：大文件的并行处理

#### 并发设置

```json
{
  "BackupConfig": {
    "MaxConcurrentBackups": 3,
    "MaxTransferThreads": 4,
    "MaxCompressionThreads": 2
  }
}
```

### 网络弹性

#### 重试机制

系统包含综合重试逻辑：

1. **指数退避**：重试之间的延迟递增
2. **抖动**：随机延迟以防止雷群效应
3. **断路器**：临时故障保护
4. **健康检查**：持续连接监控

#### 网络配置

```json
{
  "NetworkConfig": {
    "MaxRetryAttempts": 5,
    "BaseRetryDelay": "00:00:02",
    "MaxRetryDelay": "00:02:00",
    "EnableJitter": true,
    "ConnectionTimeout": "00:00:30"
  }
}
```

---

## 监控和故障排除

### 日志记录

#### 日志级别

系统使用结构化日志记录，具有以下级别：

- **Debug**：详细诊断信息
- **Information**：一般操作消息
- **Warning**：潜在有害情况
- **Error**：不会停止操作的错误事件
- **Critical**：可能导致终止的严重错误

#### 日志配置

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "MySqlBackupTool": "Debug"
    },
    "File": {
      "Path": "logs/backup-{Date}.log",
      "RollingInterval": "Day",
      "RetainedFileCountLimit": 30
    }
  }
}
```

#### 日志分析

**常见日志模式：**

```
// 成功备份
[INF] 备份操作 {OperationId} 在 {Duration} 内成功完成

// MySQL 服务问题
[ERR] 停止 MySQL 服务 {ServiceName} 失败：{ErrorMessage}

// 网络连接问题
[WRN] {Host}:{Port} 的网络连接测试失败

// 加密操作
[INF] 文件加密成功：{InputFile} -> {OutputFile}
```

### 性能监控

#### 关键指标

监控这些指标以获得最佳性能：

**备份指标：**
- 备份持续时间
- 压缩比
- 传输速度
- 成功率

**系统指标：**
- 操作期间的 CPU 使用率
- 内存消耗
- 磁盘 I/O 速率
- 网络吞吐量

**错误指标：**
- 按操作类型的失败率
- 重试尝试次数
- 网络超时频率

#### 性能仪表板

系统提供内置仪表板显示：

- 最近备份历史
- 成功/失败率
- 平均备份时间
- 存储利用率
- 调度遵守情况

### 常见问题故障排除

#### MySQL 服务问题

**问题**：MySQL 服务无法停止
**解决方案**：
1. 检查活动连接
2. 验证服务权限
3. 必要时使用强制停止
4. 检查 MySQL 错误日志

**问题**：备份后 MySQL 服务无法启动
**解决方案**：
1. 验证数据目录完整性
2. 检查 MySQL 配置文件
3. 查看 MySQL 错误日志
4. 必要时手动启动服务

#### 网络连接问题

**问题**：无法连接到备份服务器
**解决方案**：
1. 验证服务器正在运行
2. 检查防火墙设置
3. 测试网络连接
4. 验证端口配置

**问题**：传输超时
**解决方案**：
1. 增加超时值
2. 检查网络稳定性
3. 减少块大小
4. 启用恢复功能

#### 存储问题

**问题**：磁盘空间不足
**解决方案**：
1. 启用保留策略
2. 增加存储容量
3. 压缩旧备份
4. 将备份移动到外部存储

**问题**：备份文件损坏
**解决方案**：
1. 启用文件验证
2. 使用校验和进行验证
3. 测试备份恢复
4. 检查存储硬件

---

## 最佳实践

### 安全最佳实践

#### 密码管理
- 为每个配置使用唯一的强密码
- 将密码存储在安全的密码管理器中
- 定期轮换加密密码
- 永远不要以明文形式存储密码

#### 网络安全
- 为远程备份操作使用 VPN
- 为所有网络通信启用 TLS
- 实施适当的防火墙规则
- 监控网络访问日志

#### 文件安全
- 为所有备份文件启用加密
- 设置适当的文件权限
- 使用安全的存储位置
- 实施访问审计

### 操作最佳实践

#### 备份策略
- 实施 3-2-1 备份规则（3 个副本，2 种不同媒体，1 个异地）
- 定期测试备份恢复
- 记录备份程序
- 培训员工备份操作

#### 调度
- 在低使用期间安排备份
- 错开多个备份调度
- 允许足够的完成时间
- 监控调度遵守情况

#### 监控
- 为故障设置自动警报
- 监控备份完成时间
- 跟踪存储利用率趋势
- 定期查看日志

### 性能最佳实践

#### 资源管理
- 分配足够的 CPU 和内存
- 为临时文件使用快速存储
- 优化网络带宽使用
- 监控系统资源使用

#### 配置优化
- 为您的数据调整压缩设置
- 为您的网络调整块大小
- 配置适当的超时值
- 在有益的地方启用并行处理

#### 维护
- 定期更新软件
- 清理旧日志文件
- 优化数据库索引
- 查看和更新配置

### 灾难恢复

#### 备份验证
- 定期测试备份恢复
- 验证备份文件完整性
- 测试加密/解密过程
- 记录恢复程序

#### 恢复计划
- 创建详细的恢复程序
- 定期测试恢复场景
- 维护离线备份副本
- 记录紧急联系信息

#### 业务连续性
- 计划延长停机时间
- 识别关键与非关键系统
- 建立恢复时间目标（RTO）
- 定义恢复点目标（RPO）

---

## 支持和资源

### 获取帮助

- **文档**：综合指南和 API 参考
- **日志分析**：使用结构化日志进行故障排除
- **社区论坛**：与其他用户联系
- **专业支持**：企业客户可用

### 其他资源

- **示例配置**：常见场景的示例配置
- **PowerShell 脚本**：高级用户的自动化脚本
- **集成示例**：自定义集成的代码示例
- **性能调优指南**：高级优化技术

### 报告问题

报告问题时，请包括：
- 系统配置详情
- 相关日志条目
- 重现问题的步骤
- 预期与实际行为
- 截图（如适用）

---

本用户指南提供了有效使用 MySQL 备份工具的综合信息。有关技术实现详情，请参阅 API 参考文档。