# 服务端存储目录修改说明

## 修改概述

修改了服务端的备份文件存储目录逻辑，从硬编码的系统路径改为使用客户端备份配置中的 `TargetDirectory`。同时修复了客户端文件传输服务中 `FileMetadata.SourceConfig` 缺失的问题。

## 修改的文件

### 服务端修改

#### 1. `src/MySqlBackupTool.Shared/Interfaces/IStorageManager.cs`
- 添加了新的方法重载 `CreateBackupPathAsync(BackupMetadata metadata, string? customTargetDirectory)`
- 支持传入自定义目标目录参数

#### 2. `src/MySqlBackupTool.Shared/Services/StorageManager.cs`
- 修改了 `CreateBackupPathAsync` 方法，添加了支持自定义目标目录的重载版本
- 原有的无参数版本保持向后兼容，内部调用新版本并传入 `null`
- 新版本逻辑：
  - 如果提供了 `customTargetDirectory`，使用该目录作为基础路径
  - 如果未提供，使用默认的 `_baseStoragePath`
  - 自动创建目标目录（如果不存在）
  - 记录日志，标明使用的是自定义目录还是默认目录

#### 3. `src/MySqlBackupTool.Shared/Services/FileReceiver.cs`
- 修改了 `ProcessFileTransferAsync` 方法中创建备份路径的逻辑
- 从 `TransferRequest.Metadata.SourceConfig.TargetDirectory` 提取客户端配置的目标目录
- 调用 `StorageManager.CreateBackupPathAsync` 时传入客户端的目标目录
- 添加日志记录，显示使用的是客户端指定的目录还是服务器默认目录

#### 4. `src/MySqlBackupTool.Shared/Services/SecureFileReceiver.cs`
- 修改了 `ProcessFileTransferAsync` 方法中创建备份路径的逻辑
- 从 `TransferRequest.Metadata.SourceConfig.TargetDirectory` 提取客户端配置的目标目录
- 调用 `StorageManager.CreateBackupPathAsync` 时传入客户端的目标目录
- 添加日志记录，显示使用的是客户端指定的目录还是服务器默认目录（安全传输）

#### 5. `src/MySqlBackupTool.Server/Program.cs`
- 移除了硬编码的存储路径：
  ```csharp
  // 旧代码（已删除）：
  var storagePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData), "MySqlBackupTool", "Backups");
  services.AddServerServices(storagePath, false);
  
  // 新代码：
  services.AddServerServices(baseStoragePath: null, useSecureReceiver: false);
  ```
- 现在服务端不再强制指定存储路径，而是由客户端配置决定

### 客户端修改

#### 6. `src/MySqlBackupTool.Shared/Services/FileTransferClient.cs`
- 修改了 `CreateFileMetadataAsync` 方法，添加 `TransferConfig` 参数
- 在创建 `FileMetadata` 时设置 `SourceConfig` 属性，包含：
  - `TargetDirectory`：从 `TransferConfig.TargetDirectory` 获取
  - `TargetServer`：从 `TransferConfig.TargetServer` 获取
  - 其他必要的配置信息
- 更新了所有调用 `CreateFileMetadataAsync` 的地方，传入 `config` 参数

#### 7. `src/MySqlBackupTool.Shared/Services/SecureFileTransferClient.cs`
- 修改了 `CreateFileMetadataAsync` 方法，添加 `TransferConfig` 参数
- 在创建 `FileMetadata` 时设置 `SourceConfig` 属性
- 更新了所有调用 `CreateFileMetadataAsync` 的地方，传入 `config` 参数

#### 8. `src/MySqlBackupTool.Shared/Services/AuthenticatedFileTransferClient.cs`
- 修改了直接创建 `FileMetadata` 的两个地方（普通传输和恢复传输）
- 在创建 `FileMetadata` 时添加 `SourceConfig` 属性设置
- 包含完整的备份配置信息，确保服务端能够获取到 `TargetDirectory`

## 工作原理

1. **客户端配置**：客户端在 `TransferConfig` 中设置 `TargetDirectory`
2. **元数据创建**：客户端文件传输服务创建 `FileMetadata` 时，将 `TransferConfig` 信息封装到 `SourceConfig` 中
3. **传输请求**：客户端发送 `TransferRequest` 时，`Metadata.SourceConfig` 包含完整的配置信息
4. **服务端接收**：服务端的 `FileReceiver` 或 `SecureFileReceiver` 从 `TransferRequest.Metadata.SourceConfig.TargetDirectory` 提取目标目录
5. **路径创建**：`StorageManager` 使用客户端指定的目录作为基础路径，在其下创建组织化的目录结构
6. **向后兼容**：如果客户端未提供 `TargetDirectory`，服务端使用默认路径

## 优势

1. **完整的数据流**：从客户端配置到服务端存储的完整数据传递链
2. **灵活性**：每个客户端可以指定自己的备份存储位置
3. **多租户支持**：不同客户端的备份可以存储在不同的目录中
4. **安全传输支持**：SSL/TLS 加密传输也支持客户端指定的目标目录
5. **向后兼容**：保持了原有的 API 接口，不会破坏现有代码
6. **清晰的日志**：记录了使用的是客户端目录还是默认目录

## 示例

### 客户端配置示例
```csharp
var transferConfig = new TransferConfig
{
    TargetServer = new ServerEndpoint
    {
        IPAddress = "192.168.1.100",
        Port = 8080
    },
    TargetDirectory = @"D:\Backups\Production",  // 客户端指定的目录
    FileName = "backup.zip",
    ChunkingStrategy = new ChunkingStrategy()
};

// 文件传输客户端会自动将这些信息封装到 FileMetadata.SourceConfig 中
await fileTransferClient.TransferFileAsync(filePath, transferConfig);
```

### 服务端日志示例

**普通传输：**
```
info: MySqlBackupTool.Shared.Services.FileReceiver[0]
      Using client-specified target directory for backup storage: D:\Backups\Production

info: MySqlBackupTool.Shared.Services.StorageManager[0]
      Created backup path: D:\Backups\Production\2026\02\05\ProductionDB_MySQL_20260205_143022.zip (using custom directory)
```

**安全传输：**
```
info: MySqlBackupTool.Shared.Services.SecureFileReceiver[0]
      Using client-specified target directory for secure backup storage: D:\Backups\Production

info: MySqlBackupTool.Shared.Services.StorageManager[0]
      Created backup path: D:\Backups\Production\2026\02\05\ProductionDB_MySQL_20260205_143022.zip (using custom directory)
```

## 测试

- 构建成功：所有项目编译通过
- 向后兼容：保持了原有的方法签名
- 完整数据流：客户端到服务端的完整配置传递链已建立
- 多种传输方式：普通传输、安全传输、认证传输都已修改

## 注意事项

1. 客户端需要在 `TransferConfig.TargetDirectory` 中指定有效路径
2. 服务端需要对客户端指定的目录有写入权限
3. 如果目录不存在，服务端会自动创建
4. 建议在生产环境中使用绝对路径
5. 服务端会在客户端指定的目录下创建子目录结构（按年/月/日组织）
6. 无论使用哪种文件传输客户端（普通、安全、认证），都会正确传递目标目录信息
